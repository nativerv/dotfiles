#!/bin/sh

# Functions necessary to run this config
source "${ZDOTDIR}/zsh_functions"

### Source all config files

# All of below depend on `zsh_functions`
zsh_add_file "zsh_exports"

################################################
       ### PEEPOS, first of all...
 [[ -o login ]] && random-pepe 2>/dev/null
################################################

# Continue normally with mundane stuff...
zsh_add_file "zsh_options"
zsh_add_file "zsh_aliases"
zsh_add_file "zsh_prompt"
zsh_add_file "zsh_vim_mode"
zsh_add_file "zsh_keybindings"
zsh_add_file "zsh_plugins"

### Load zsh modules =================

# Enable zsh's profiling module
zmodload zsh/zprof

# Enable pywal colors in terminal by pasting 
# it's escape sequences
(cat ~/.cache/wal/sequences &)

### Start X on login

RED='\033[0;31m'
NC='\033[0m' # No Color

ERROR="${RED}ERROR: ${NC}"

maybe_startx () {

  # Continue to the terminal if in the pseudo terminal, not TTY
  tty | grep -q '^/dev/pts' && return

  echo "Starting X server...";

  # Trow to shell if not on first TTY
  if [ ! "$(tty)" = '/dev/tty1' ]; then
    echo "${ERROR}You are not in the first TTY. X server won't start."
    echo "Leaving you in the shell."
    return;
  fi

  # Throw to shell if `DISPLAY` is already set
  if ! [ -z "${DISPLAY}" ]; then
    echo "${ERROR}ERROR: \`DISPLAY\` is already set. X server already running on this TTY and you seeng this message. Something wrong."
    echo "Leaving you in the shell."
    return
  fi

  # Throw to shell if `startx` is missing
  if [ ! -x /bin/startx ]; then
    echo "${ERROR}: Seems like the X server is not installed or not properly installed: \`startx\` is not in your \`PATH\`. X server won't start."
    echo "Leaving you in the shell."
    return
  fi

  exec startx "${XINITRC}" >>"${XDG_DATA_HOME}/xinitrc/xinitrc.log" 2>>"${XDG_DATA_HOME}/xinitrc/xinitrc.error.log"
}

# Only start if `DISPLAY == "" && tty == tty1 && startx`
maybe_startx
