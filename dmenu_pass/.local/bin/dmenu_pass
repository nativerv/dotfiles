#!/bin/sh

# Author: nrv
# License: https://www.gnu.org/licenses/gpl-3.0.en.html
# Description: 
#   Select password from password-store, 
#   write it to ${DMENU_PASS_CURRENT} record and run `dmenu_pass_current`

set -ex

PASSWORD_STORE_DIR="${PASSWORD_STORE_DIR:-"${HOME}/.local/share/pass"}"
DMENU_PASS_CURRENT="${DMENU_PASS_CURRENT:-"dmenu_pass_current"}"

cut_pass_dir="$(printf 's|^%s/||g; s|.gpg$||g' "${PASSWORD_STORE_DIR}")"
filter_dmenu_pass_current="${DMENU_PASS_CURRENT}"

# Find desired password container
pass_file="$(
  find "${PASSWORD_STORE_DIR}" -iname "*.gpg" \
    | sed "${cut_pass_dir}" \
    | grep -v "${filter_dmenu_pass_current}" \
    | dmenu -l 10 -p "Select field: "
)"

# Symlink it - so it is "currently selected"
ln -sf "${PASSWORD_STORE_DIR}/${pass_file}.gpg" "${PASSWORD_STORE_DIR}/${DMENU_PASS_CURRENT}.gpg"

# The dmenu_pass_current will handle currently selected container
dmenu_pass_current "${@}"

# shopt -s nullglob globstar
# set -x
#
# typeit=0
# if [[ $1 == "--type" ]]; then
#   typeit=1
#   shift
# fi
#
# if [[ -n $WAYLAND_DISPLAY ]]; then
#   dmenu="dmenu-wl"
#   xdotool="ydotool type --file -"
# elif [[ -n $DISPLAY ]]; then
#   dmenu=dmenu
#   xdotool="xdotool type --clearmodifiers --file -"
# else
#   echo "Error: No Wayland or X11 display detected" >&2
#   exit 1
# fi
#
# prefix=${PASSWORD_STORE_DIR-~/.password-store}
# password_files=( "$prefix"/**/*.gpg )
# password_files=( "${password_files[@]#"$prefix"/}" )
# password_files=( "${password_files[@]%.gpg}" )
#
# password=$(printf '%s\n' "${password_files[@]}" | "$dmenu" "$@")
#
# [[ -n $password ]] || exit
#
# if [[ $typeit -eq 0 ]]; then
#   pass show -c "$password" 2>/dev/null
# else
#   pass show "$password" | { IFS= read -r pass; printf %s "$pass"; } | $xdotool
# fi
