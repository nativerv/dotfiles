#!/bin/sh

# Author: nrv
# License: https://www.gnu.org/licenses/gpl-3.0.en.html 
# Description:
#   In password-store,
#   for a selected pass record of form:
#     password
#     key: value
#     key: value
#     key: value
#   Yank value to clipboard or type it

set -e

DMENU_PASS_CURRENT="${DMENU_PASS_CURRENT:-'dmenu_pass_current'}"

password_placeholder='****************                                                                                                '
password="$(pass show "${DMENU_PASS_CURRENT}" | head -n1)"

# Select value from password-store record
selected_value="$(
  pass show "${DMENU_PASS_CURRENT}" \
    | sed "1 s/.*/password: ${password_placeholder}/g" \
    | dmenu -l 10 -p 'Select field: ' \
    | sed 's/: /\t/g' \
    | cut -f2
)"

# Replace placeholder with actual password if password was selected
[ "${selected_value}" = "${password_placeholder}" ] && selected_value="${password}"

action="$(
  printf 'Type\nYank' | dmenu -p 'Choose an antion: ' -l 2
)"

# Perform action - type or copy
if [ "${action}" = 'Type' ]; then
  xdotool type "${selected_value}"
elif [ "${action}" = 'Yank' ]; then
  printf '%s' "${selected_value}" | xclip -in -sel clipboard
else
  printf '%s' "${selected_value}"
fi
